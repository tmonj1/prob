#
# see AWS Load Balancer Controller(https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html)
#

#
# 1. OIDCプロバイダの作成
#

# クラスタ用のOIDCプロバイダを作成
$ eksctl utils associate-iam-oidc-provider --cluster eks-worker-cluster --approve

# (参考)OIDCプロバイダがすでに作成されているかは以下のコマンドでわかる
$ aws iam list-open-id-connect-providers | grep B3D3B415A1400510E206544DC04F37EB 
$ eksctl utils associate-iam-oidc-provider --cluster eks-worker-cluster --approve

#
# 2. AWS LBC 用のサービスアカウントを作成
#

# AWS Load Balancer Controller に設定するポリシードキュメントをダウンロード
$ curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.2.0/docs/install/iam_policy.json

# 確認
$ ls
iam_policy.json

# ポリシーを作成
$ aws iam create-policy \
    --policy-name AWSLoadBalancerControllerIAMPolicy \
    --policy-document file://iam_policy.json
{
    "Policy": {
        "PolicyName": "AWSLoadBalancerControllerIAMPolicy",
        "PolicyId": "ANPAVNT6IZTILF7O57QO7",
        "Arn": "arn:aws:iam::372853230800:policy/AWSLoadBalancerControllerIAMPolicy",
        "Path": "/",
        "DefaultVersionId": "v1",
        "AttachmentCount": 0,
        "PermissionsBoundaryUsageCount": 0,
        "IsAttachable": true,
        "CreateDate": "2021-09-14T09:58:01+00:00",
        "UpdateDate": "2021-09-14T09:58:01+00:00"
    }
}

# ポリシーに紐付いたサービスアカウントを作成(裏でポリシーをアタッチしたロールも生成される)
$ eksctl create iamserviceaccount \
  --cluster=eks-worker-cluster \
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --attach-policy-arn=arn:aws:iam::372853230800:policy/AWSLoadBalancerControllerIAMPolicy \
  --override-existing-serviceaccounts \
  --approve

# 作成されたことを確認
k get sa -n kube-system |grep load-balancer
aws-load-balancer-controller         1         1h

#
# 3. 関連するCRDを作成
#


# TargetGroupBinding等のCRDを作成
$ kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller/crds?ref=master"
customresourcedefinition.apiextensions.k8s.io/ingressclassparams.elbv2.k8s.aws created
customresourcedefinition.apiextensions.k8s.io/targetgroupbindings.elbv2.k8s.aws created

#
# 4. AWS LBCのインストール
#

# Helm Chartでインストール
$ helm repo add eks https://aws.github.io/eks-charts
$ helm repo update
$ helm upgrade -i aws-load-balancer-controller eks/aws-load-balancer-controller \
  --set clusterName=eks-worker-cluster \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller \
  -n kube-system

# (注) IRSAを使っている場合、以下を指定したほうが良い気がするが指定しなかった
# --set region=region-code
# --set vpcId=vpc-xxxxxxxx

# 確認
kubectl get deployment -n kube-system aws-load-balancer-controller
NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
aws-load-balancer-controller   2/2     2            2           15s

